# bolt_project/plans/check_and_apply_acl.yaml
version: 2
parameters:
  targets:
    type: TargetSpec
  user:
    type: String
  password:
    type: String
  running_config:
    type: Array
steps:
  - name: check_acl
    eval: >
      if ('ip access-list standard TEST_ACL' in $running_config[0]['result']['stdout'] and
          'permit 192.168.0.0 0.0.255.255' in $running_config[0]['result']['stdout']) {
        return {'apply_acl': false}
      } else {
        return {'apply_acl': true}
      }

  - name: maybe_apply_acl
    eval: |
      if $check_acl['apply_acl'] {
        [
          {
            "name": "apply_acl_task",
            "task": "bolt_project::ios_command",
            "targets": $targets,
            "parameters": {
              "host": $targets[0]['uri'],
              "user": $user,
              "password": $password,
              "command": "configure terminal\nip access-list standard TEST_ACL\npermit 192.168.0.0 0.0.255.255"
            }
          }
        ]
      } else {
        []
      }

return: "ACL applied to ${targets} if necessary"
